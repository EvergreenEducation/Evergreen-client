{"ast":null,"code":"import _objectSpread from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\nimport _asyncToGenerator from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _mapValues from \"lodash/mapValues\";\nimport _flow from \"lodash/flow\";\nimport _groupBy from \"lodash/groupBy\";\nimport _head from \"lodash/head\";\nimport _orderBy from \"lodash/orderBy\";\nimport _compact from \"lodash/compact\";\nvar _jsxFileName = \"/home/devnineteen/Music/evergreen-frontend/src/components/offer/OfferUpdateModal.js\";\n\n(function () {\n  var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;\n  enterModule && enterModule(module);\n})();\n\nvar __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {\n  return a;\n};\n\nimport React, { useEffect, useRef } from 'react';\nimport { Modal, Form, Table, Button, notification } from 'antd';\nimport useAxios, { configure } from 'axios-hooks';\nimport axiosInstance from 'services/AxiosInstance';\nimport useGlobalStore from 'store/GlobalStore';\nimport OfferForm from 'components/offer/OfferForm';\nimport dayjs from 'dayjs';\nimport moment from 'moment';\nimport AuthService from 'services/AuthService';\nimport UploaderService from 'services/Uploader';\nimport { useImageAndBannerImage } from 'hooks';\nimport 'assets/scss/antd-overrides.scss';\nconfigure({\n  axios: axiosInstance\n});\nconst Column = Table.Column;\nexport default function OfferUpdateModal({\n  offer,\n  onCancel,\n  visible,\n  offerStore,\n  scopedToProvider = false,\n  role\n}) {\n  const formRef = useRef(null);\n  const _AuthService$currentS = AuthService.currentSession,\n        userId = _AuthService$currentS.id,\n        provider_id = _AuthService$currentS.provider_id;\n\n  const _useImageAndBannerIma = useImageAndBannerImage(),\n        _useImageAndBannerIma2 = _slicedToArray(_useImageAndBannerIma, 3),\n        _useImageAndBannerIma3 = _useImageAndBannerIma2[0],\n        file = _useImageAndBannerIma3.file,\n        newFile = _useImageAndBannerIma3.newFile,\n        onFileChange = _useImageAndBannerIma3.onFileChange,\n        setFile = _useImageAndBannerIma3.setFile,\n        onChangeFileUpload = _useImageAndBannerIma3.onChangeFileUpload,\n        _useImageAndBannerIma4 = _useImageAndBannerIma2[1],\n        bannerFile = _useImageAndBannerIma4.bannerFile,\n        onBannerFileChange = _useImageAndBannerIma4.onBannerFileChange,\n        newBannerFile = _useImageAndBannerIma4.newBannerFile,\n        setBannerFile = _useImageAndBannerIma4.setBannerFile,\n        onChangeBannerUpload = _useImageAndBannerIma4.onChangeBannerUpload,\n        reset = _useImageAndBannerIma2[2];\n\n  const _offer$RelatedOffers = offer.RelatedOffers,\n        RelatedOffers = _offer$RelatedOffers === void 0 ? [] : _offer$RelatedOffers,\n        _offer$PrerequisiteOf = offer.PrerequisiteOffers,\n        PrerequisiteOffers = _offer$PrerequisiteOf === void 0 ? [] : _offer$PrerequisiteOf,\n        _offer$DataFields = offer.DataFields,\n        DataFields = _offer$DataFields === void 0 ? [] : _offer$DataFields,\n        _offer$GroupsOfOffers = offer.GroupsOfOffers,\n        Pathways = _offer$GroupsOfOffers === void 0 ? [] : _offer$GroupsOfOffers;\n\n  const _Form$useForm = Form.useForm(),\n        _Form$useForm2 = _slicedToArray(_Form$useForm, 1),\n        form = _Form$useForm2[0];\n\n  const _useAxios = useAxios({\n    method: 'PUT'\n  }, {\n    manual: true\n  }),\n        _useAxios2 = _slicedToArray(_useAxios, 2),\n        updateOfferError = _useAxios2[0].error,\n        updateOffer = _useAxios2[1];\n\n  const _useGlobalStore = useGlobalStore(),\n        datafieldStore = _useGlobalStore.datafield,\n        providerStore = _useGlobalStore.provider;\n\n  const submitUpdate = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator(function* () {\n      try {\n        const values = yield form.validateFields(['generic_type', 'is_generic', 'rubric_attachment', 'location_type', 'category', 'description', 'learn_and_earn', 'frequency', 'frequency_unit', 'cost', 'cost_unit', 'credit_unit', 'pay_unit', 'length', 'length_unit', 'name', 'provider_id', 'topics', 'pay', 'credit', 'keywords', 'related_offers', 'prerequisites', 'is_local_promo', 'is_main_promo', 'external_url']);\n\n        const _yield$updateOffer = yield updateOffer({\n          url: `/offers/${offer.id}`,\n          data: _objectSpread(_objectSpread({}, values), {}, {\n            updatedAt: new dayjs().toISOString()\n          })\n        }),\n              data = _yield$updateOffer.data,\n              status = _yield$updateOffer.status;\n\n        const fileable_type = 'offer';\n        let filePayload = [];\n\n        if (data && userId) {\n          const offerEntity = offerStore.entities[data.id];\n          filePayload = [...offerEntity.Files];\n\n          if (onFileChange && newFile) {\n            const results = yield UploaderService.uploadFile(newFile, {\n              uploaded_by_user_id: userId,\n              fileable_type,\n              fileable_id: data.id\n            });\n\n            if (results && results.file.data) {\n              filePayload.push(_objectSpread({}, results.file.data));\n            }\n\n            if (results.success) {\n              notification.success({\n                message: 'Success',\n                description: 'Main image is uploaded'\n              });\n            }\n          }\n\n          if (onBannerFileChange && newBannerFile) {\n            const results = yield UploaderService.uploadFile(newBannerFile, {\n              uploaded_by_user_id: userId,\n              fileable_type,\n              fileable_id: data.id,\n              meta: 'banner-image'\n            });\n\n            if (results && results.file.data) {\n              filePayload.push(_objectSpread({}, results.file.data));\n            }\n\n            if (results.success) {\n              notification.success({\n                message: 'Success',\n                description: 'Banner image is uploaded'\n              });\n            }\n          }\n        }\n\n        if (data) {\n          offerStore.updateOne(data);\n        }\n\n        if (status === 200) {\n          if (filePayload.length) {\n            let clonedData = Object.assign(data);\n            clonedData.Files = filePayload;\n            offerStore.updateOne(clonedData);\n          }\n\n          notification.success({\n            message: status,\n            description: 'Successfully updated offer'\n          });\n          onCancel();\n        }\n      } catch (error) {\n        console.error(error);\n      }\n    });\n\n    return function submitUpdate() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  function populateFields(o) {\n    form.setFieldsValue(_objectSpread(_objectSpread({}, o), {}, {\n      pay_unit: Number(o.pay_unit),\n      length_unit: Number(o.length_unit),\n      credit_unit: Number(o.credit_unit),\n      frequency_unit: Number(o.frequency_unit),\n      category: Number(o.category),\n      cost_unit: Number(o.cost_unit),\n      start_date: moment(o.start_date),\n      topics: _compact(DataFields.map(({\n        type,\n        id\n      }) => {\n        if (type === 'topic') {\n          return id;\n        }\n\n        return null;\n      })),\n      related_offers: RelatedOffers.map(({\n        id\n      }) => id),\n      prerequisites: PrerequisiteOffers.map(({\n        id\n      }) => id)\n    }));\n  }\n\n  useEffect(() => {\n    if (updateOfferError) {\n      const _updateOfferError$req = updateOfferError.request,\n            status = _updateOfferError$req.status,\n            statusText = _updateOfferError$req.statusText;\n      notification.error({\n        message: status,\n        description: statusText\n      });\n    }\n\n    if (formRef.current) {\n      populateFields(offer);\n    }\n\n    if (offer.Files) {\n      let groupedFiles = _flow([v => v.filter(f => f.fileable_type === 'offer'), v => _groupBy(v, 'meta'), v => _mapValues(v, f => _orderBy(f, ['fileable_type', 'createdAt', 'id'], ['desc', 'desc', 'asc']))])(offer.Files);\n\n      if (!onFileChange && groupedFiles[null]) {\n        setFile(_head(groupedFiles[null]));\n      }\n\n      if (!onBannerFileChange && groupedFiles['banner-image']) {\n        setBannerFile(_head(groupedFiles['banner-image']));\n      }\n    }\n  }, [offer, updateOfferError, formRef, file, bannerFile]);\n  return /*#__PURE__*/React.createElement(Modal, {\n    destroyOnClose: true,\n    forceRender: true,\n    className: \"custom-modal\",\n    title: 'Update Offer',\n    visible: visible,\n    width: 998,\n    bodyStyle: {\n      backgroundColor: '#f0f2f5',\n      padding: 0\n    },\n    footer: true,\n    onCancel: onCancel,\n    afterClose: () => {\n      reset();\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 233,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Form, {\n    form: form,\n    ref: formRef,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 247,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"p-6 overflow-y-auto\",\n    style: {\n      maxHeight: '32rem'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 248,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(OfferForm, {\n    offers: Object.values(offerStore.entities),\n    datafields: datafieldStore.entities,\n    providers: providerStore.entities,\n    offer: offer,\n    userId: userId,\n    providerId: provider_id,\n    onChangeUpload: onChangeFileUpload,\n    file: file,\n    scopedToProvider: scopedToProvider,\n    role: role,\n    bannerFile: bannerFile,\n    onChangeBannerUpload: onChangeBannerUpload,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 249,\n      columnNumber: 11\n    }\n  }), /*#__PURE__*/React.createElement(\"section\", {\n    className: \"mt-2\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 263,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(\"label\", {\n    className: \"mb-2 block\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 264,\n      columnNumber: 13\n    }\n  }, \"Pathways - Table\"), /*#__PURE__*/React.createElement(Table, {\n    dataSource: Pathways,\n    className: \"ant-table-wrapper--responsive\",\n    rowClassName: () => 'antd-row',\n    rowKey: \"id\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 265,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Column, {\n    className: \"antd-col\",\n    title: \"ID\",\n    dataIndex: \"id\",\n    key: \"id\",\n    render: (text, record) => ({\n      children: text,\n      props: {\n        'data-title': 'ID'\n      }\n    }),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(Column, {\n    className: \"antd-col\",\n    title: \"Pathway Name\",\n    dataIndex: \"name\",\n    key: \"name\",\n    render: (text, record) => ({\n      children: text,\n      props: {\n        'data-title': 'Pathway Name'\n      }\n    }),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 283,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(Column, {\n    className: \"antd-col\",\n    title: \"Pathway Description\",\n    dataIndex: \"description\",\n    key: \"index\",\n    render: (text, record) => {\n      let children = 'N/A';\n\n      if (text.length) {\n        children = text;\n      }\n\n      return {\n        children: children,\n        props: {\n          'data-title': 'Pathway Description'\n        }\n      };\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 295,\n      columnNumber: 15\n    }\n  })))), /*#__PURE__*/React.createElement(\"section\", {\n    className: \"bg-white px-6 pt-5 pb-1 flex justify-center\",\n    style: {\n      borderTop: '1px solid #f0f0f0'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 316,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    className: \"mr-3 px-10 rounded\",\n    size: \"small\",\n    type: \"primary\",\n    htmlType: \"submit\",\n    onClick: submitUpdate,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 322,\n      columnNumber: 11\n    }\n  }, \"Update\"), /*#__PURE__*/React.createElement(Button, {\n    className: \"px-10 rounded\",\n    size: \"small\",\n    type: \"dashed\",\n    onClick: () => onCancel(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 331,\n      columnNumber: 11\n    }\n  }, \"Cancel\"))));\n}\n\n__signature__(OfferUpdateModal, \"useRef{formRef}\\nuseImageAndBannerImage{[\\r\\n    { file, newFile, onFileChange, setFile, onChangeFileUpload },\\r\\n    {\\r\\n      bannerFile,\\r\\n      onBannerFileChange,\\r\\n      newBannerFile,\\r\\n      setBannerFile,\\r\\n      onChangeBannerUpload,\\r\\n    },\\r\\n    reset,\\r\\n  ]}\\nuseForm{[form]}\\nuseAxios{[{ error: updateOfferError }, updateOffer]}\\nuseGlobalStore{{\\r\\n    datafield: datafieldStore,\\r\\n    provider: providerStore,\\r\\n  }}\\nuseEffect{}\", () => [useImageAndBannerImage, useAxios, useGlobalStore]);\n\n;\n\n(function () {\n  var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;\n\n  if (!reactHotLoader) {\n    return;\n  }\n\n  reactHotLoader.register(Column, \"Column\", \"/home/devnineteen/Music/evergreen-frontend/src/components/offer/OfferUpdateModal.js\");\n  reactHotLoader.register(OfferUpdateModal, \"OfferUpdateModal\", \"/home/devnineteen/Music/evergreen-frontend/src/components/offer/OfferUpdateModal.js\");\n})();\n\n;\n\n(function () {\n  var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;\n  leaveModule && leaveModule(module);\n})();","map":{"version":3,"sources":["/home/devnineteen/Music/evergreen-frontend/src/components/offer/OfferUpdateModal.js"],"names":["React","useEffect","useRef","Modal","Form","Table","Button","notification","useAxios","configure","axiosInstance","useGlobalStore","OfferForm","dayjs","moment","AuthService","UploaderService","useImageAndBannerImage","axios","Column","OfferUpdateModal","offer","onCancel","visible","offerStore","scopedToProvider","role","formRef","currentSession","userId","id","provider_id","file","newFile","onFileChange","setFile","onChangeFileUpload","bannerFile","onBannerFileChange","newBannerFile","setBannerFile","onChangeBannerUpload","reset","RelatedOffers","PrerequisiteOffers","DataFields","GroupsOfOffers","Pathways","useForm","form","method","manual","updateOfferError","error","updateOffer","datafieldStore","datafield","providerStore","provider","submitUpdate","values","validateFields","url","data","updatedAt","toISOString","status","fileable_type","filePayload","offerEntity","entities","Files","results","uploadFile","uploaded_by_user_id","fileable_id","push","success","message","description","meta","updateOne","length","clonedData","Object","assign","console","populateFields","o","setFieldsValue","pay_unit","Number","length_unit","credit_unit","frequency_unit","category","cost_unit","start_date","topics","map","type","related_offers","prerequisites","request","statusText","current","groupedFiles","v","filter","f","backgroundColor","padding","maxHeight","text","record","children","props","borderTop"],"mappings":"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","sourcesContent":["import React, { useEffect, useRef } from 'react';\r\nimport { Modal, Form, Table, Button, notification } from 'antd';\r\nimport useAxios, { configure } from 'axios-hooks';\r\nimport axiosInstance from 'services/AxiosInstance';\r\nimport useGlobalStore from 'store/GlobalStore';\r\nimport OfferForm from 'components/offer/OfferForm';\r\nimport dayjs from 'dayjs';\r\nimport moment from 'moment';\r\nimport AuthService from 'services/AuthService';\r\nimport UploaderService from 'services/Uploader';\r\nimport { compact, orderBy, head, groupBy, flow, mapValues } from 'lodash';\r\nimport { useImageAndBannerImage } from 'hooks';\r\nimport 'assets/scss/antd-overrides.scss';\r\n\r\nconfigure({\r\n  axios: axiosInstance,\r\n});\r\n\r\nconst { Column } = Table;\r\n\r\nexport default function OfferUpdateModal({\r\n  offer,\r\n  onCancel,\r\n  visible,\r\n  offerStore,\r\n  scopedToProvider = false,\r\n  role,\r\n}) {\r\n  const formRef = useRef(null);\r\n  const { id: userId, provider_id } = AuthService.currentSession;\r\n  const [\r\n    { file, newFile, onFileChange, setFile, onChangeFileUpload },\r\n    {\r\n      bannerFile,\r\n      onBannerFileChange,\r\n      newBannerFile,\r\n      setBannerFile,\r\n      onChangeBannerUpload,\r\n    },\r\n    reset,\r\n  ] = useImageAndBannerImage();\r\n\r\n  const {\r\n    RelatedOffers = [],\r\n    PrerequisiteOffers = [],\r\n    DataFields = [],\r\n    GroupsOfOffers: Pathways = [],\r\n  } = offer;\r\n\r\n  const [form] = Form.useForm();\r\n\r\n  const [{ error: updateOfferError }, updateOffer] = useAxios(\r\n    {\r\n      method: 'PUT',\r\n    },\r\n    { manual: true }\r\n  );\r\n\r\n  const {\r\n    datafield: datafieldStore,\r\n    provider: providerStore,\r\n  } = useGlobalStore();\r\n\r\n  const submitUpdate = async () => {\r\n    try {\r\n      const values = await form.validateFields([\r\n        'generic_type',\r\n        'is_generic',\r\n        'rubric_attachment',\r\n        'location_type',\r\n        'category',\r\n        'description',\r\n        'learn_and_earn',\r\n        'frequency',\r\n        'frequency_unit',\r\n        'cost',\r\n        'cost_unit',\r\n        'credit_unit',\r\n        'pay_unit',\r\n        'length',\r\n        'length_unit',\r\n        'name',\r\n        'provider_id',\r\n        'topics',\r\n        'pay',\r\n        'credit',\r\n        'keywords',\r\n        'related_offers',\r\n        'prerequisites',\r\n        'is_local_promo',\r\n        'is_main_promo',\r\n        'external_url',\r\n      ]);\r\n\r\n      const { data, status } = await updateOffer({\r\n        url: `/offers/${offer.id}`,\r\n        data: {\r\n          ...values,\r\n          updatedAt: new dayjs().toISOString(),\r\n        },\r\n      });\r\n\r\n      const fileable_type = 'offer';\r\n      let filePayload = [];\r\n\r\n      if (data && userId) {\r\n        const offerEntity = offerStore.entities[data.id];\r\n        filePayload = [...offerEntity.Files];\r\n\r\n        if (onFileChange && newFile) {\r\n          const results = await UploaderService.uploadFile(newFile, {\r\n            uploaded_by_user_id: userId,\r\n            fileable_type,\r\n            fileable_id: data.id,\r\n          });\r\n\r\n          if (results && results.file.data) {\r\n            filePayload.push({\r\n              ...results.file.data,\r\n            });\r\n          }\r\n\r\n          if (results.success) {\r\n            notification.success({\r\n              message: 'Success',\r\n              description: 'Main image is uploaded',\r\n            });\r\n          }\r\n        }\r\n\r\n        if (onBannerFileChange && newBannerFile) {\r\n          const results = await UploaderService.uploadFile(newBannerFile, {\r\n            uploaded_by_user_id: userId,\r\n            fileable_type,\r\n            fileable_id: data.id,\r\n            meta: 'banner-image',\r\n          });\r\n\r\n          if (results && results.file.data) {\r\n            filePayload.push({\r\n              ...results.file.data,\r\n            });\r\n          }\r\n\r\n          if (results.success) {\r\n            notification.success({\r\n              message: 'Success',\r\n              description: 'Banner image is uploaded',\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      if (data) {\r\n        offerStore.updateOne(data);\r\n      }\r\n\r\n      if (status === 200) {\r\n        if (filePayload.length) {\r\n          let clonedData = Object.assign(data);\r\n          clonedData.Files = filePayload;\r\n          offerStore.updateOne(clonedData);\r\n        }\r\n        notification.success({\r\n          message: status,\r\n          description: 'Successfully updated offer',\r\n        });\r\n        onCancel();\r\n      }\r\n    } catch (error) {\r\n      console.error(error);\r\n    }\r\n  };\r\n\r\n  function populateFields(o) {\r\n    form.setFieldsValue({\r\n      ...o,\r\n      pay_unit: Number(o.pay_unit),\r\n      length_unit: Number(o.length_unit),\r\n      credit_unit: Number(o.credit_unit),\r\n      frequency_unit: Number(o.frequency_unit),\r\n      category: Number(o.category),\r\n      cost_unit: Number(o.cost_unit),\r\n      start_date: moment(o.start_date),\r\n      topics: compact(\r\n        DataFields.map(({ type, id }) => {\r\n          if (type === 'topic') {\r\n            return id;\r\n          }\r\n          return null;\r\n        })\r\n      ),\r\n      related_offers: RelatedOffers.map(({ id }) => id),\r\n      prerequisites: PrerequisiteOffers.map(({ id }) => id),\r\n    });\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (updateOfferError) {\r\n      const { status, statusText } = updateOfferError.request;\r\n      notification.error({\r\n        message: status,\r\n        description: statusText,\r\n      });\r\n    }\r\n    if (formRef.current) {\r\n      populateFields(offer);\r\n    }\r\n    if (offer.Files) {\r\n      let groupedFiles = flow([\r\n        (v) => v.filter((f) => f.fileable_type === 'offer'),\r\n        (v) => groupBy(v, 'meta'),\r\n        (v) =>\r\n          mapValues(v, (f) =>\r\n            orderBy(\r\n              f,\r\n              ['fileable_type', 'createdAt', 'id'],\r\n              ['desc', 'desc', 'asc']\r\n            )\r\n          ),\r\n      ])(offer.Files);\r\n\r\n      if (!onFileChange && groupedFiles[null]) {\r\n        setFile(head(groupedFiles[null]));\r\n      }\r\n      if (!onBannerFileChange && groupedFiles['banner-image']) {\r\n        setBannerFile(head(groupedFiles['banner-image']));\r\n      }\r\n    }\r\n  }, [offer, updateOfferError, formRef, file, bannerFile]);\r\n\r\n  return (\r\n    <Modal\r\n      destroyOnClose={true}\r\n      forceRender={true}\r\n      className=\"custom-modal\"\r\n      title={'Update Offer'}\r\n      visible={visible}\r\n      width={998}\r\n      bodyStyle={{ backgroundColor: '#f0f2f5', padding: 0 }}\r\n      footer={true}\r\n      onCancel={onCancel}\r\n      afterClose={() => {\r\n        reset();\r\n      }}\r\n    >\r\n      <Form form={form} ref={formRef}>\r\n        <div className=\"p-6 overflow-y-auto\" style={{ maxHeight: '32rem' }}>\r\n          <OfferForm\r\n            offers={Object.values(offerStore.entities)}\r\n            datafields={datafieldStore.entities}\r\n            providers={providerStore.entities}\r\n            offer={offer}\r\n            userId={userId}\r\n            providerId={provider_id}\r\n            onChangeUpload={onChangeFileUpload}\r\n            file={file}\r\n            scopedToProvider={scopedToProvider}\r\n            role={role}\r\n            bannerFile={bannerFile}\r\n            onChangeBannerUpload={onChangeBannerUpload}\r\n          />\r\n          <section className=\"mt-2\">\r\n            <label className=\"mb-2 block\">Pathways - Table</label>\r\n            <Table\r\n              dataSource={Pathways}\r\n              className=\"ant-table-wrapper--responsive\"\r\n              rowClassName={() => 'antd-row'}\r\n              rowKey=\"id\"\r\n            >\r\n              <Column\r\n                className=\"antd-col\"\r\n                title=\"ID\"\r\n                dataIndex=\"id\"\r\n                key=\"id\"\r\n                render={(text, record) => ({\r\n                  children: text,\r\n                  props: {\r\n                    'data-title': 'ID',\r\n                  },\r\n                })}\r\n              />\r\n              <Column\r\n                className=\"antd-col\"\r\n                title=\"Pathway Name\"\r\n                dataIndex=\"name\"\r\n                key=\"name\"\r\n                render={(text, record) => ({\r\n                  children: text,\r\n                  props: {\r\n                    'data-title': 'Pathway Name',\r\n                  },\r\n                })}\r\n              />\r\n              <Column\r\n                className=\"antd-col\"\r\n                title=\"Pathway Description\"\r\n                dataIndex=\"description\"\r\n                key=\"index\"\r\n                render={(text, record) => {\r\n                  let children = 'N/A';\r\n                  if (text.length) {\r\n                    children = text;\r\n                  }\r\n                  return {\r\n                    children: children,\r\n                    props: {\r\n                      'data-title': 'Pathway Description',\r\n                    },\r\n                  };\r\n                }}\r\n              />\r\n            </Table>\r\n          </section>\r\n        </div>\r\n        <section\r\n          className=\"bg-white px-6 pt-5 pb-1 flex justify-center\"\r\n          style={{\r\n            borderTop: '1px solid #f0f0f0',\r\n          }}\r\n        >\r\n          <Button\r\n            className=\"mr-3 px-10 rounded\"\r\n            size=\"small\"\r\n            type=\"primary\"\r\n            htmlType=\"submit\"\r\n            onClick={submitUpdate}\r\n          >\r\n            Update\r\n          </Button>\r\n          <Button\r\n            className=\"px-10 rounded\"\r\n            size=\"small\"\r\n            type=\"dashed\"\r\n            onClick={() => onCancel()}\r\n          >\r\n            Cancel\r\n          </Button>\r\n        </section>\r\n      </Form>\r\n    </Modal>\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}