{"ast":null,"code":"import _objectSpread from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\nimport _asyncToGenerator from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"/home/devnineteen/Music/evergreen-frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _flowRight from \"lodash/flowRight\";\nimport _mapValues from \"lodash/mapValues\";\nimport _sortBy from \"lodash/sortBy\";\nimport _reject from \"lodash/reject\";\nimport _head from \"lodash/head\";\nimport _map from \"lodash/map\";\nimport _orderBy from \"lodash/orderBy\";\nimport _isNil from \"lodash/isNil\";\nimport _groupBy from \"lodash/groupBy\";\nvar _jsxFileName = \"/home/devnineteen/Music/evergreen-frontend/src/components/pathway/PathwayUpdateModal.js\";\n\n(function () {\n  var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;\n  enterModule && enterModule(module);\n})();\n\nvar __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {\n  return a;\n};\n\nimport React, { useEffect, useState, useRef } from 'react';\nimport { Modal, Form, Button, notification } from 'antd';\nimport useAxios, { configure } from 'axios-hooks';\nimport axiosInstance from 'services/AxiosInstance';\nimport DataFieldStore from 'store/DataField';\nimport PathwayForm from 'components/pathway/PathwayForm';\nimport AuthService from 'services/AuthService';\nimport UploaderService from 'services/Uploader';\nimport OfferStore from 'store/Offer';\nimport { useImageAndBannerImage } from 'hooks';\nimport 'assets/scss/antd-overrides.scss';\nconfigure({\n  axios: axiosInstance\n});\nexport default function PathwayUpdateModal({\n  pathway,\n  onCancel,\n  visible,\n  pathwayStore,\n  providers,\n  role\n}) {\n  const formRef = useRef(null);\n  const _AuthService$currentS = AuthService.currentSession,\n        userId = _AuthService$currentS.id,\n        provider_id = _AuthService$currentS.provider_id;\n\n  const _useImageAndBannerIma = useImageAndBannerImage(),\n        _useImageAndBannerIma2 = _slicedToArray(_useImageAndBannerIma, 3),\n        _useImageAndBannerIma3 = _useImageAndBannerIma2[0],\n        file = _useImageAndBannerIma3.file,\n        newFile = _useImageAndBannerIma3.newFile,\n        onFileChange = _useImageAndBannerIma3.onFileChange,\n        setFile = _useImageAndBannerIma3.setFile,\n        onChangeFileUpload = _useImageAndBannerIma3.onChangeFileUpload,\n        _useImageAndBannerIma4 = _useImageAndBannerIma2[1],\n        bannerFile = _useImageAndBannerIma4.bannerFile,\n        onBannerFileChange = _useImageAndBannerIma4.onBannerFileChange,\n        newBannerFile = _useImageAndBannerIma4.newBannerFile,\n        setBannerFile = _useImageAndBannerIma4.setBannerFile,\n        onChangeBannerUpload = _useImageAndBannerIma4.onChangeBannerUpload,\n        reset = _useImageAndBannerIma2[2];\n\n  const _useState = useState([]),\n        _useState2 = _slicedToArray(_useState, 2),\n        groupsOfOffers = _useState2[0],\n        setGroupsOfOffers = _useState2[1];\n\n  const _Form$useForm = Form.useForm(),\n        _Form$useForm2 = _slicedToArray(_Form$useForm, 1),\n        form = _Form$useForm2[0];\n\n  const datafieldStore = DataFieldStore.useContainer();\n  const offerStore = OfferStore.useContainer();\n\n  const _useAxios = useAxios({\n    method: 'PUT'\n  }, {\n    manual: true\n  }),\n        _useAxios2 = _slicedToArray(_useAxios, 2),\n        putError = _useAxios2[0].error,\n        updatePathway = _useAxios2[1];\n\n  const submitUpdate = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator(function* () {\n      try {\n        const values = yield form.validateFields(['rubric_attachment', 'location_type', 'description', 'learn_and_earn', 'frequency', 'frequency_unit', 'name', 'topics', 'outlook', 'earnings', 'type', 'keywords', 'provider_id', 'is_local_promo', 'is_main_promo', 'external_url']);\n        let groupOrderByYearNum = [];\n\n        let groups_of_offers = _map(groupsOfOffers, g => {\n          const year = form.getFieldValue(g.group_name);\n          groupOrderByYearNum.push(g.group_name);\n          const results = {\n            group_name: g.group_name,\n            offer_ids: g.removed ? [] : _map(g.offers, 'offer_id'),\n            year\n          };\n          const semester = form.getFieldValue(`${g.group_name}_semester`) || null;\n\n          if (semester) {\n            return _objectSpread(_objectSpread({}, results), {}, {\n              semester,\n              year\n            });\n          }\n\n          return results;\n        });\n\n        const groupOrder = yield form.validateFields(groupOrderByYearNum);\n        let yearSubmission = [];\n\n        for (const key in groupOrder) {\n          yearSubmission.push({\n            group_name: key,\n            year: groupOrder[key]\n          });\n        }\n\n        yearSubmission = _sortBy(yearSubmission, ['year']).map(({\n          group_name\n        }) => group_name);\n\n        const _yield$updatePathway = yield updatePathway({\n          url: `/pathways/${pathway.id}`,\n          data: _objectSpread(_objectSpread({}, values), {}, {\n            group_sort_order: yearSubmission,\n            groups_of_offers\n          })\n        }),\n              data = _yield$updatePathway.data,\n              status = _yield$updatePathway.status;\n\n        const fileable_type = 'pathway';\n        let filePayload = [];\n\n        if (data && userId) {\n          const pathwayEntity = pathwayStore.entities[data.id];\n          filePayload = [...pathwayEntity.Files];\n\n          if (onFileChange && newFile) {\n            const results = yield UploaderService.uploadFile(newFile, {\n              uploaded_by_user_id: userId,\n              fileable_type,\n              fileable_id: data.id\n            });\n\n            if (results && results.file.data) {\n              filePayload.push(_objectSpread({}, results.file.data));\n            }\n\n            if (results.success) {\n              notification.success({\n                message: 'Success',\n                description: 'Main image is uploaded'\n              });\n            }\n          }\n\n          if (onBannerFileChange && newBannerFile) {\n            const results = yield UploaderService.uploadFile(newBannerFile, {\n              uploaded_by_user_id: userId,\n              fileable_type,\n              fileable_id: data.id,\n              meta: 'banner-image'\n            });\n\n            if (results && results.file.data) {\n              filePayload.push(_objectSpread({}, results.file.data));\n            }\n\n            if (results.success) {\n              notification.success({\n                message: 'Success',\n                description: 'Banner image is uploaded'\n              });\n            }\n          }\n        }\n\n        if (data) {\n          pathwayStore.updateOne(data);\n        }\n\n        if (status === 200) {\n          if (filePayload.length) {\n            let clonedData = Object.assign(data);\n            clonedData.Files = filePayload;\n            pathwayStore.updateOne(clonedData);\n          }\n\n          notification.success({\n            message: status,\n            description: 'Successfully updated pathway'\n          });\n          onCancel();\n        }\n      } catch (err) {\n        console.error(err);\n      }\n    });\n\n    return function submitUpdate() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  const groupedDataFields = _groupBy(pathway.DataFields, 'type') || [];\n  let myTopics = [];\n\n  if (!_isNil(groupedDataFields.topic)) {\n    myTopics = groupedDataFields.topic.reduce((acc, curr, index) => {\n      if (_isNil(acc)) {\n        return [];\n      }\n\n      acc.push(curr.id);\n      return acc;\n    }, []);\n  }\n\n  function populateFields(p) {\n    form.setFieldsValue(_objectSpread(_objectSpread({}, p), {}, {\n      frequency_unit: Number(p.frequency_unit),\n      topics: myTopics\n    }));\n  }\n\n  useEffect(() => {\n    if (formRef.current) {\n      populateFields(pathway);\n    }\n\n    if (formRef.current && role === 'provider') {\n      if (providerEntities.length) {\n        providerEntities = _reject(providerEntities, p => {\n          return !(p.id === provider_id);\n        });\n        form.setFieldsValue({\n          provider_id: _head(providerEntities).id || null\n        });\n      }\n    }\n\n    if (putError) {\n      const _putError$request = putError.request,\n            status = _putError$request.status,\n            statusText = _putError$request.statusText;\n      notification.error({\n        message: status,\n        description: statusText\n      });\n    }\n\n    if (pathway.Files) {\n      let groupedFiles = _flowRight([v => _mapValues(v, f => _orderBy(f, ['fileable_type', 'createdAt', 'id'], ['desc', 'desc', 'asc'])), v => _groupBy(v, 'meta'), v => v.filter(f => f.fileable_type === 'pathway')])(pathway.Files);\n\n      if (!onFileChange && groupedFiles[null]) {\n        setFile(_head(groupedFiles[null]));\n      }\n\n      if (!onBannerFileChange && groupedFiles['banner-image']) {\n        setBannerFile(_head(groupedFiles['banner-image']));\n      }\n    }\n  }, [pathway, putError, formRef, file, bannerFile]);\n  let providerEntities = providers;\n  return /*#__PURE__*/React.createElement(Modal, {\n    forceRender: true,\n    className: \"custom-modal\",\n    title: 'Update Pathway',\n    visible: visible,\n    width: 998,\n    bodyStyle: {\n      backgroundColor: '#f0f2f5',\n      padding: 0\n    },\n    footer: true,\n    onCancel: onCancel,\n    afterClose: () => {\n      reset();\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 272,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Form, {\n    form: form,\n    ref: formRef,\n    initialValues: {\n      provider_id: role === 'provider' && providers && providers.length ? _head(providers).id : null\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 285,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"p-6 overflow-y-auto\",\n    style: {\n      maxHeight: '32rem'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 295,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(PathwayForm, {\n    pathway: pathway,\n    datafields: datafieldStore.entities,\n    offers: Object.values(offerStore.entities),\n    groupsOfOffers: groupsOfOffers,\n    setGroupsOfOffers: setGroupsOfOffers,\n    userId: userId,\n    onChangeUpload: onChangeFileUpload,\n    file: file,\n    bannerFile: bannerFile,\n    onChangeBannerUpload: onChangeBannerUpload,\n    providers: providerEntities,\n    role: role,\n    form: form,\n    offerStore: offerStore,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 296,\n      columnNumber: 11\n    }\n  })), /*#__PURE__*/React.createElement(\"section\", {\n    className: \"bg-white px-6 pt-5 pb-1 flex justify-center\",\n    style: {\n      borderTop: '1px solid #f0f0f0'\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 313,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    className: \"mr-3 px-10 rounded\",\n    size: \"small\",\n    type: \"primary\",\n    htmlType: \"submit\",\n    onClick: submitUpdate,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 319,\n      columnNumber: 11\n    }\n  }, \"Update\"), /*#__PURE__*/React.createElement(Button, {\n    className: \"px-10 rounded\",\n    size: \"small\",\n    type: \"dashed\",\n    onClick: () => onCancel(),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 328,\n      columnNumber: 11\n    }\n  }, \"Cancel\"))));\n}\n\n__signature__(PathwayUpdateModal, \"useRef{formRef}\\nuseImageAndBannerImage{[\\r\\n    { file, newFile, onFileChange, setFile, onChangeFileUpload },\\r\\n    {\\r\\n      bannerFile,\\r\\n      onBannerFileChange,\\r\\n      newBannerFile,\\r\\n      setBannerFile,\\r\\n      onChangeBannerUpload,\\r\\n    },\\r\\n    reset,\\r\\n  ]}\\nuseState{[groupsOfOffers, setGroupsOfOffers]([])}\\nuseForm{[form]}\\nuseContainer{datafieldStore}\\nuseContainer{offerStore}\\nuseAxios{[{ error: putError }, updatePathway]}\\nuseEffect{}\", () => [useImageAndBannerImage, useAxios]);\n\n;\n\n(function () {\n  var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;\n\n  if (!reactHotLoader) {\n    return;\n  }\n\n  reactHotLoader.register(PathwayUpdateModal, \"PathwayUpdateModal\", \"/home/devnineteen/Music/evergreen-frontend/src/components/pathway/PathwayUpdateModal.js\");\n})();\n\n;\n\n(function () {\n  var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;\n  leaveModule && leaveModule(module);\n})();","map":{"version":3,"sources":["/home/devnineteen/Music/evergreen-frontend/src/components/pathway/PathwayUpdateModal.js"],"names":["React","useEffect","useState","useRef","Modal","Form","Button","notification","useAxios","configure","axiosInstance","DataFieldStore","PathwayForm","AuthService","UploaderService","OfferStore","useImageAndBannerImage","axios","PathwayUpdateModal","pathway","onCancel","visible","pathwayStore","providers","role","formRef","currentSession","userId","id","provider_id","file","newFile","onFileChange","setFile","onChangeFileUpload","bannerFile","onBannerFileChange","newBannerFile","setBannerFile","onChangeBannerUpload","reset","groupsOfOffers","setGroupsOfOffers","useForm","form","datafieldStore","useContainer","offerStore","method","manual","putError","error","updatePathway","submitUpdate","values","validateFields","groupOrderByYearNum","groups_of_offers","g","year","getFieldValue","group_name","push","results","offer_ids","removed","offers","semester","groupOrder","yearSubmission","key","map","url","data","group_sort_order","status","fileable_type","filePayload","pathwayEntity","entities","Files","uploadFile","uploaded_by_user_id","fileable_id","success","message","description","meta","updateOne","length","clonedData","Object","assign","err","console","groupedDataFields","DataFields","myTopics","topic","reduce","acc","curr","index","populateFields","p","setFieldsValue","frequency_unit","Number","topics","current","providerEntities","request","statusText","groupedFiles","v","f","filter","backgroundColor","padding","maxHeight","borderTop"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useRef } from 'react';\r\nimport { Modal, Form, Button, notification } from 'antd';\r\nimport useAxios, { configure } from 'axios-hooks';\r\nimport axiosInstance from 'services/AxiosInstance';\r\nimport DataFieldStore from 'store/DataField';\r\nimport PathwayForm from 'components/pathway/PathwayForm';\r\nimport {\r\n  groupBy,\r\n  isNil,\r\n  orderBy,\r\n  map,\r\n  head,\r\n  reject,\r\n  sortBy,\r\n  mapValues,\r\n  flowRight,\r\n} from 'lodash';\r\nimport AuthService from 'services/AuthService';\r\nimport UploaderService from 'services/Uploader';\r\nimport OfferStore from 'store/Offer';\r\nimport { useImageAndBannerImage } from 'hooks';\r\nimport 'assets/scss/antd-overrides.scss';\r\n\r\nconfigure({\r\n  axios: axiosInstance,\r\n});\r\n\r\nexport default function PathwayUpdateModal({\r\n  pathway,\r\n  onCancel,\r\n  visible,\r\n  pathwayStore,\r\n  providers,\r\n  role,\r\n}) {\r\n  const formRef = useRef(null);\r\n  const { id: userId, provider_id } = AuthService.currentSession;\r\n  const [\r\n    { file, newFile, onFileChange, setFile, onChangeFileUpload },\r\n    {\r\n      bannerFile,\r\n      onBannerFileChange,\r\n      newBannerFile,\r\n      setBannerFile,\r\n      onChangeBannerUpload,\r\n    },\r\n    reset,\r\n  ] = useImageAndBannerImage();\r\n\r\n  const [groupsOfOffers, setGroupsOfOffers] = useState([]);\r\n\r\n  const [form] = Form.useForm();\r\n  const datafieldStore = DataFieldStore.useContainer();\r\n  const offerStore = OfferStore.useContainer();\r\n  const [{ error: putError }, updatePathway] = useAxios(\r\n    {\r\n      method: 'PUT',\r\n    },\r\n    { manual: true }\r\n  );\r\n\r\n  const submitUpdate = async () => {\r\n    try {\r\n      const values = await form.validateFields([\r\n        'rubric_attachment',\r\n        'location_type',\r\n        'description',\r\n        'learn_and_earn',\r\n        'frequency',\r\n        'frequency_unit',\r\n        'name',\r\n        'topics',\r\n        'outlook',\r\n        'earnings',\r\n        'type',\r\n        'keywords',\r\n        'provider_id',\r\n        'is_local_promo',\r\n        'is_main_promo',\r\n        'external_url',\r\n      ]);\r\n\r\n      let groupOrderByYearNum = [];\r\n      let groups_of_offers = map(groupsOfOffers, (g) => {\r\n        const year = form.getFieldValue(g.group_name);\r\n        groupOrderByYearNum.push(g.group_name);\r\n        const results = {\r\n          group_name: g.group_name,\r\n          offer_ids: g.removed ? [] : map(g.offers, 'offer_id'),\r\n          year,\r\n        };\r\n        const semester = form.getFieldValue(`${g.group_name}_semester`) || null;\r\n\r\n        if (semester) {\r\n          return {\r\n            ...results,\r\n            semester,\r\n            year,\r\n          };\r\n        }\r\n\r\n        return results;\r\n      });\r\n\r\n      const groupOrder = await form.validateFields(groupOrderByYearNum);\r\n      let yearSubmission = [];\r\n      for (const key in groupOrder) {\r\n        yearSubmission.push({\r\n          group_name: key,\r\n          year: groupOrder[key],\r\n        });\r\n      }\r\n\r\n      yearSubmission = sortBy(yearSubmission, ['year']).map(\r\n        ({ group_name }) => group_name\r\n      );\r\n\r\n      const { data, status } = await updatePathway({\r\n        url: `/pathways/${pathway.id}`,\r\n        data: {\r\n          ...values,\r\n          group_sort_order: yearSubmission,\r\n          groups_of_offers,\r\n        },\r\n      });\r\n\r\n      const fileable_type = 'pathway';\r\n      let filePayload = [];\r\n\r\n      if (data && userId) {\r\n        const pathwayEntity = pathwayStore.entities[data.id];\r\n        filePayload = [...pathwayEntity.Files];\r\n\r\n        if (onFileChange && newFile) {\r\n          const results = await UploaderService.uploadFile(newFile, {\r\n            uploaded_by_user_id: userId,\r\n            fileable_type,\r\n            fileable_id: data.id,\r\n          });\r\n\r\n          if (results && results.file.data) {\r\n            filePayload.push({\r\n              ...results.file.data,\r\n            });\r\n          }\r\n\r\n          if (results.success) {\r\n            notification.success({\r\n              message: 'Success',\r\n              description: 'Main image is uploaded',\r\n            });\r\n          }\r\n        }\r\n\r\n        if (onBannerFileChange && newBannerFile) {\r\n          const results = await UploaderService.uploadFile(newBannerFile, {\r\n            uploaded_by_user_id: userId,\r\n            fileable_type,\r\n            fileable_id: data.id,\r\n            meta: 'banner-image',\r\n          });\r\n\r\n          if (results && results.file.data) {\r\n            filePayload.push({\r\n              ...results.file.data,\r\n            });\r\n          }\r\n\r\n          if (results.success) {\r\n            notification.success({\r\n              message: 'Success',\r\n              description: 'Banner image is uploaded',\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      if (data) {\r\n        pathwayStore.updateOne(data);\r\n      }\r\n\r\n      if (status === 200) {\r\n        if (filePayload.length) {\r\n          let clonedData = Object.assign(data);\r\n          clonedData.Files = filePayload;\r\n          pathwayStore.updateOne(clonedData);\r\n        }\r\n        notification.success({\r\n          message: status,\r\n          description: 'Successfully updated pathway',\r\n        });\r\n        onCancel();\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n    }\r\n  };\r\n\r\n  const groupedDataFields = groupBy(pathway.DataFields, 'type') || [];\r\n\r\n  let myTopics = [];\r\n\r\n  if (!isNil(groupedDataFields.topic)) {\r\n    myTopics = groupedDataFields.topic.reduce((acc, curr, index) => {\r\n      if (isNil(acc)) {\r\n        return [];\r\n      }\r\n      acc.push(curr.id);\r\n      return acc;\r\n    }, []);\r\n  }\r\n\r\n  function populateFields(p) {\r\n    form.setFieldsValue({\r\n      ...p,\r\n      frequency_unit: Number(p.frequency_unit),\r\n      topics: myTopics,\r\n    });\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (formRef.current) {\r\n      populateFields(pathway);\r\n    }\r\n\r\n    if (formRef.current && role === 'provider') {\r\n      if (providerEntities.length) {\r\n        providerEntities = reject(providerEntities, (p) => {\r\n          return !(p.id === provider_id);\r\n        });\r\n\r\n        form.setFieldsValue({\r\n          provider_id: head(providerEntities).id || null,\r\n        });\r\n      }\r\n    }\r\n\r\n    if (putError) {\r\n      const { status, statusText } = putError.request;\r\n      notification.error({\r\n        message: status,\r\n        description: statusText,\r\n      });\r\n    }\r\n\r\n    if (pathway.Files) {\r\n      let groupedFiles = flowRight([\r\n        (v) =>\r\n          mapValues(v, (f) =>\r\n            orderBy(\r\n              f,\r\n              ['fileable_type', 'createdAt', 'id'],\r\n              ['desc', 'desc', 'asc']\r\n            )\r\n          ),\r\n        (v) => groupBy(v, 'meta'),\r\n        (v) => v.filter((f) => f.fileable_type === 'pathway'),\r\n      ])(pathway.Files);\r\n\r\n      if (!onFileChange && groupedFiles[null]) {\r\n        setFile(head(groupedFiles[null]));\r\n      }\r\n      if (!onBannerFileChange && groupedFiles['banner-image']) {\r\n        setBannerFile(head(groupedFiles['banner-image']));\r\n      }\r\n    }\r\n  }, [pathway, putError, formRef, file, bannerFile]);\r\n\r\n  let providerEntities = providers;\r\n\r\n  return (\r\n    <Modal\r\n      forceRender={true}\r\n      className=\"custom-modal\"\r\n      title={'Update Pathway'}\r\n      visible={visible}\r\n      width={998}\r\n      bodyStyle={{ backgroundColor: '#f0f2f5', padding: 0 }}\r\n      footer={true}\r\n      onCancel={onCancel}\r\n      afterClose={() => {\r\n        reset();\r\n      }}\r\n    >\r\n      <Form\r\n        form={form}\r\n        ref={formRef}\r\n        initialValues={{\r\n          provider_id:\r\n            role === 'provider' && providers && providers.length\r\n              ? head(providers).id\r\n              : null,\r\n        }}\r\n      >\r\n        <div className=\"p-6 overflow-y-auto\" style={{ maxHeight: '32rem' }}>\r\n          <PathwayForm\r\n            pathway={pathway}\r\n            datafields={datafieldStore.entities}\r\n            offers={Object.values(offerStore.entities)}\r\n            groupsOfOffers={groupsOfOffers}\r\n            setGroupsOfOffers={setGroupsOfOffers}\r\n            userId={userId}\r\n            onChangeUpload={onChangeFileUpload}\r\n            file={file}\r\n            bannerFile={bannerFile}\r\n            onChangeBannerUpload={onChangeBannerUpload}\r\n            providers={providerEntities}\r\n            role={role}\r\n            form={form}\r\n            offerStore={offerStore}\r\n          />\r\n        </div>\r\n        <section\r\n          className=\"bg-white px-6 pt-5 pb-1 flex justify-center\"\r\n          style={{\r\n            borderTop: '1px solid #f0f0f0',\r\n          }}\r\n        >\r\n          <Button\r\n            className=\"mr-3 px-10 rounded\"\r\n            size=\"small\"\r\n            type=\"primary\"\r\n            htmlType=\"submit\"\r\n            onClick={submitUpdate}\r\n          >\r\n            Update\r\n          </Button>\r\n          <Button\r\n            className=\"px-10 rounded\"\r\n            size=\"small\"\r\n            type=\"dashed\"\r\n            onClick={() => onCancel()}\r\n          >\r\n            Cancel\r\n          </Button>\r\n        </section>\r\n      </Form>\r\n    </Modal>\r\n  );\r\n}\r\n"]},"metadata":{},"sourceType":"module"}