{"ast":null,"code":"var _class, _temp;\n\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}\n\nfunction _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  subClass.__proto__ = superClass;\n}\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n/**\n * This plugin is currently a A Big Hackâ„¢! The core reason for that is how this plugin\n * interacts with Uppy's current pipeline design. The pipeline can handle files in steps,\n * including preprocessing, uploading, and postprocessing steps. This plugin initially\n * was designed to do its work in a preprocessing step, and let XHRUpload deal with the\n * actual file upload as an uploading step. However, Uppy runs steps on all files at once,\n * sequentially: first, all files go through a preprocessing step, then, once they are all\n * done, they go through the uploading step.\n *\n * For S3, this causes severely broken behaviour when users upload many files. The\n * preprocessing step will request S3 upload URLs that are valid for a short time only,\n * but it has to do this for _all_ files, which can take a long time if there are hundreds\n * or even thousands of files. By the time the uploader step starts, the first URLs may\n * already have expired. If not, the uploading might take such a long time that later URLs\n * will expire before some files can be uploaded.\n *\n * The long-term solution to this problem is to change the upload pipeline so that files\n * can be sent to the next step individually. That requires a breakig change, so it is\n * planned for Uppy v2.\n *\n * In the mean time, this plugin is stuck with a hackier approach: the necessary parts\n * of the XHRUpload implementation were copied into this plugin, as the MiniXHRUpload\n * class, and this plugin calls into it immediately once it receives an upload URL.\n * This isn't as nicely modular as we'd like and requires us to maintain two copies of\n * the XHRUpload code, but at least it's not horrifically broken :)\n */\n// If global `URL` constructor is available, use it\n\n\nvar URL_ = typeof URL === 'function' ? URL : require('url-parse');\n\nvar _require = require('@uppy/core'),\n    Plugin = _require.Plugin;\n\nvar Translator = require('@uppy/utils/lib/Translator');\n\nvar RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue');\n\nvar settle = require('@uppy/utils/lib/settle');\n\nvar hasProperty = require('@uppy/utils/lib/hasProperty');\n\nvar _require2 = require('@uppy/companion-client'),\n    RequestClient = _require2.RequestClient;\n\nvar qsStringify = require('qs-stringify');\n\nvar MiniXHRUpload = require('./MiniXHRUpload');\n\nvar isXml = require('./isXml');\n\nfunction resolveUrl(origin, link) {\n  return origin ? new URL_(link, origin).toString() : new URL_(link).toString();\n}\n/**\n * Get the contents of a named tag in an XML source string.\n *\n * @param {string} source - The XML source string.\n * @param {string} tagName - The name of the tag.\n * @returns {string} The contents of the tag, or the empty string if the tag does not exist.\n */\n\n\nfunction getXmlValue(source, tagName) {\n  var start = source.indexOf(\"<\" + tagName + \">\");\n  var end = source.indexOf(\"</\" + tagName + \">\", start);\n  return start !== -1 && end !== -1 ? source.slice(start + tagName.length + 2, end) : '';\n}\n\nfunction assertServerError(res) {\n  if (res && res.error) {\n    var error = new Error(res.message);\n\n    _extends(error, res.error);\n\n    throw error;\n  }\n\n  return res;\n} // warning deduplication flag: see `getResponseData()` XHRUpload option definition\n\n\nvar warnedSuccessActionStatus = false;\nmodule.exports = (_temp = _class = /*#__PURE__*/function (_Plugin) {\n  _inheritsLoose(AwsS3, _Plugin);\n\n  function AwsS3(uppy, opts) {\n    var _this;\n\n    _this = _Plugin.call(this, uppy, opts) || this;\n    _this.type = 'uploader';\n    _this.id = _this.opts.id || 'AwsS3';\n    _this.title = 'AWS S3';\n    _this.defaultLocale = {\n      strings: {\n        timedOut: 'Upload stalled for %{seconds} seconds, aborting.'\n      }\n    };\n    var defaultOptions = {\n      timeout: 30 * 1000,\n      limit: 0,\n      metaFields: [],\n      // have to opt in\n      getUploadParameters: _this.getUploadParameters.bind(_assertThisInitialized(_this))\n    };\n    _this.opts = _extends({}, defaultOptions, opts);\n\n    _this.i18nInit();\n\n    _this.client = new RequestClient(uppy, opts);\n    _this.handleUpload = _this.handleUpload.bind(_assertThisInitialized(_this));\n    _this.requests = new RateLimitedQueue(_this.opts.limit);\n    return _this;\n  }\n\n  var _proto = AwsS3.prototype;\n\n  _proto.setOptions = function setOptions(newOpts) {\n    _Plugin.prototype.setOptions.call(this, newOpts);\n\n    this.i18nInit();\n  };\n\n  _proto.i18nInit = function i18nInit() {\n    this.translator = new Translator([this.defaultLocale, this.uppy.locale, this.opts.locale]);\n    this.i18n = this.translator.translate.bind(this.translator);\n    this.setPluginState(); // so that UI re-renders and we see the updated locale\n  };\n\n  _proto.getUploadParameters = function getUploadParameters(file) {\n    if (!this.opts.companionUrl) {\n      throw new Error('Expected a `companionUrl` option containing a Companion address.');\n    }\n\n    var filename = file.meta.name;\n    var type = file.meta.type;\n    var metadata = {};\n    this.opts.metaFields.forEach(function (key) {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString();\n      }\n    });\n    var query = qsStringify({\n      filename: filename,\n      type: type,\n      metadata: metadata\n    });\n    return this.client.get(\"s3/params?\" + query).then(assertServerError);\n  };\n\n  _proto.validateParameters = function validateParameters(file, params) {\n    var valid = typeof params === 'object' && params && typeof params.url === 'string' && (typeof params.fields === 'object' || params.fields == null) && (params.method == null || /^(put|post)$/i.test(params.method));\n\n    if (!valid) {\n      var err = new TypeError(\"AwsS3: got incorrect result from 'getUploadParameters()' for file '\" + file.name + \"', expected an object '{ url, method, fields, headers }' but got '\" + JSON.stringify(params) + \"' instead.\\nSee https://uppy.io/docs/aws-s3/#getUploadParameters-file for more on the expected format.\");\n      console.error(err);\n      throw err;\n    }\n  };\n\n  _proto.handleUpload = function handleUpload(fileIDs) {\n    var _this2 = this;\n    /**\n     * keep track of `getUploadParameters()` responses\n     * so we can cancel the calls individually using just a file ID\n     *\n     * @type {object.<string, Promise>}\n     */\n\n\n    var paramsPromises = Object.create(null);\n\n    function onremove(file) {\n      var id = file.id;\n\n      if (hasProperty(paramsPromises, id)) {\n        paramsPromises[id].abort();\n      }\n    }\n\n    this.uppy.on('file-removed', onremove);\n    fileIDs.forEach(function (id) {\n      var file = _this2.uppy.getFile(id);\n\n      _this2.uppy.emit('upload-started', file);\n    });\n    var getUploadParameters = this.requests.wrapPromiseFunction(function (file) {\n      return _this2.opts.getUploadParameters(file);\n    });\n    var numberOfFiles = fileIDs.length;\n    return settle(fileIDs.map(function (id, index) {\n      paramsPromises[id] = getUploadParameters(_this2.uppy.getFile(id));\n      return paramsPromises[id].then(function (params) {\n        delete paramsPromises[id];\n\n        var file = _this2.uppy.getFile(id);\n\n        _this2.validateParameters(file, params);\n\n        var _params$method = params.method,\n            method = _params$method === void 0 ? 'post' : _params$method,\n            url = params.url,\n            fields = params.fields,\n            headers = params.headers;\n        var xhrOpts = {\n          method: method,\n          formData: method.toLowerCase() === 'post',\n          endpoint: url,\n          metaFields: fields ? Object.keys(fields) : []\n        };\n\n        if (headers) {\n          xhrOpts.headers = headers;\n        }\n\n        _this2.uppy.setFileState(file.id, {\n          meta: _extends({}, file.meta, fields),\n          xhrUpload: xhrOpts\n        });\n\n        return _this2._uploader.uploadFile(file.id, index, numberOfFiles);\n      }).catch(function (error) {\n        delete paramsPromises[id];\n\n        var file = _this2.uppy.getFile(id);\n\n        _this2.uppy.emit('upload-error', file, error);\n      });\n    })).then(function (settled) {\n      // cleanup.\n      _this2.uppy.off('file-removed', onremove);\n\n      return settled;\n    });\n  };\n\n  _proto.install = function install() {\n    var uppy = this.uppy;\n    this.uppy.addUploader(this.handleUpload); // Get the response data from a successful XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n\n    function defaultGetResponseData(content, xhr) {\n      var opts = this; // If no response, we've hopefully done a PUT request to the file\n      // in the bucket on its full URL.\n\n      if (!isXml(content, xhr)) {\n        if (opts.method.toUpperCase() === 'POST') {\n          if (!warnedSuccessActionStatus) {\n            uppy.log('[AwsS3] No response data found, make sure to set the success_action_status AWS SDK option to 201. See https://uppy.io/docs/aws-s3/#POST-Uploads', 'warning');\n            warnedSuccessActionStatus = true;\n          } // The responseURL won't contain the object key. Give up.\n\n\n          return {\n            location: null\n          };\n        } // responseURL is not available in older browsers.\n\n\n        if (!xhr.responseURL) {\n          return {\n            location: null\n          };\n        } // Trim the query string because it's going to be a bunch of presign\n        // parameters for a PUT requestâ€”doing a GET request with those will\n        // always result in an error\n\n\n        return {\n          location: xhr.responseURL.replace(/\\?.*$/, '')\n        };\n      }\n\n      return {\n        // Some S3 alternatives do not reply with an absolute URL.\n        // Eg DigitalOcean Spaces uses /$bucketName/xyz\n        location: resolveUrl(xhr.responseURL, getXmlValue(content, 'Location')),\n        bucket: getXmlValue(content, 'Bucket'),\n        key: getXmlValue(content, 'Key'),\n        etag: getXmlValue(content, 'ETag')\n      };\n    } // Get the error data from a failed XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n\n\n    function defaultGetResponseError(content, xhr) {\n      // If no response, we don't have a specific error message, use the default.\n      if (!isXml(content, xhr)) {\n        return;\n      }\n\n      var error = getXmlValue(content, 'Message');\n      return new Error(error);\n    }\n\n    var xhrOptions = {\n      fieldName: 'file',\n      responseUrlFieldName: 'location',\n      timeout: this.opts.timeout,\n      // Share the rate limiting queue with XHRUpload.\n      __queue: this.requests,\n      responseType: 'text',\n      getResponseData: this.opts.getResponseData || defaultGetResponseData,\n      getResponseError: defaultGetResponseError\n    }; // Only for MiniXHRUpload, remove once we can depend on XHRUpload directly again\n\n    xhrOptions.i18n = this.i18n; // Revert to `this.uppy.use(XHRUpload)` once the big comment block at the top of\n    // this file is solved\n\n    this._uploader = new MiniXHRUpload(this.uppy, xhrOptions);\n  };\n\n  _proto.uninstall = function uninstall() {\n    this.uppy.removePreProcessor(this.handleUpload);\n  };\n\n  return AwsS3;\n}(Plugin), _class.VERSION = \"1.7.0\", _temp);","map":{"version":3,"sources":["/home/devnineteen/Music/evergreen-frontend/node_modules/@uppy/aws-s3/lib/index.js"],"names":["_class","_temp","_assertThisInitialized","self","ReferenceError","_inheritsLoose","subClass","superClass","prototype","Object","create","constructor","__proto__","_extends","assign","target","i","arguments","length","source","key","hasOwnProperty","call","apply","URL_","URL","require","_require","Plugin","Translator","RateLimitedQueue","settle","hasProperty","_require2","RequestClient","qsStringify","MiniXHRUpload","isXml","resolveUrl","origin","link","toString","getXmlValue","tagName","start","indexOf","end","slice","assertServerError","res","error","Error","message","warnedSuccessActionStatus","module","exports","_Plugin","AwsS3","uppy","opts","_this","type","id","title","defaultLocale","strings","timedOut","defaultOptions","timeout","limit","metaFields","getUploadParameters","bind","i18nInit","client","handleUpload","requests","_proto","setOptions","newOpts","translator","locale","i18n","translate","setPluginState","file","companionUrl","filename","meta","name","metadata","forEach","query","get","then","validateParameters","params","valid","url","fields","method","test","err","TypeError","JSON","stringify","console","fileIDs","_this2","paramsPromises","onremove","abort","on","getFile","emit","wrapPromiseFunction","numberOfFiles","map","index","_params$method","headers","xhrOpts","formData","toLowerCase","endpoint","keys","setFileState","xhrUpload","_uploader","uploadFile","catch","settled","off","install","addUploader","defaultGetResponseData","content","xhr","toUpperCase","log","location","responseURL","replace","bucket","etag","defaultGetResponseError","xhrOptions","fieldName","responseUrlFieldName","__queue","responseType","getResponseData","getResponseError","uninstall","removePreProcessor","VERSION"],"mappings":"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","sourcesContent":["var _class, _temp;\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\n/**\n * This plugin is currently a A Big Hackâ„¢! The core reason for that is how this plugin\n * interacts with Uppy's current pipeline design. The pipeline can handle files in steps,\n * including preprocessing, uploading, and postprocessing steps. This plugin initially\n * was designed to do its work in a preprocessing step, and let XHRUpload deal with the\n * actual file upload as an uploading step. However, Uppy runs steps on all files at once,\n * sequentially: first, all files go through a preprocessing step, then, once they are all\n * done, they go through the uploading step.\n *\n * For S3, this causes severely broken behaviour when users upload many files. The\n * preprocessing step will request S3 upload URLs that are valid for a short time only,\n * but it has to do this for _all_ files, which can take a long time if there are hundreds\n * or even thousands of files. By the time the uploader step starts, the first URLs may\n * already have expired. If not, the uploading might take such a long time that later URLs\n * will expire before some files can be uploaded.\n *\n * The long-term solution to this problem is to change the upload pipeline so that files\n * can be sent to the next step individually. That requires a breakig change, so it is\n * planned for Uppy v2.\n *\n * In the mean time, this plugin is stuck with a hackier approach: the necessary parts\n * of the XHRUpload implementation were copied into this plugin, as the MiniXHRUpload\n * class, and this plugin calls into it immediately once it receives an upload URL.\n * This isn't as nicely modular as we'd like and requires us to maintain two copies of\n * the XHRUpload code, but at least it's not horrifically broken :)\n */\n// If global `URL` constructor is available, use it\nvar URL_ = typeof URL === 'function' ? URL : require('url-parse');\n\nvar _require = require('@uppy/core'),\n    Plugin = _require.Plugin;\n\nvar Translator = require('@uppy/utils/lib/Translator');\n\nvar RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue');\n\nvar settle = require('@uppy/utils/lib/settle');\n\nvar hasProperty = require('@uppy/utils/lib/hasProperty');\n\nvar _require2 = require('@uppy/companion-client'),\n    RequestClient = _require2.RequestClient;\n\nvar qsStringify = require('qs-stringify');\n\nvar MiniXHRUpload = require('./MiniXHRUpload');\n\nvar isXml = require('./isXml');\n\nfunction resolveUrl(origin, link) {\n  return origin ? new URL_(link, origin).toString() : new URL_(link).toString();\n}\n/**\n * Get the contents of a named tag in an XML source string.\n *\n * @param {string} source - The XML source string.\n * @param {string} tagName - The name of the tag.\n * @returns {string} The contents of the tag, or the empty string if the tag does not exist.\n */\n\n\nfunction getXmlValue(source, tagName) {\n  var start = source.indexOf(\"<\" + tagName + \">\");\n  var end = source.indexOf(\"</\" + tagName + \">\", start);\n  return start !== -1 && end !== -1 ? source.slice(start + tagName.length + 2, end) : '';\n}\n\nfunction assertServerError(res) {\n  if (res && res.error) {\n    var error = new Error(res.message);\n\n    _extends(error, res.error);\n\n    throw error;\n  }\n\n  return res;\n} // warning deduplication flag: see `getResponseData()` XHRUpload option definition\n\n\nvar warnedSuccessActionStatus = false;\nmodule.exports = (_temp = _class = /*#__PURE__*/function (_Plugin) {\n  _inheritsLoose(AwsS3, _Plugin);\n\n  function AwsS3(uppy, opts) {\n    var _this;\n\n    _this = _Plugin.call(this, uppy, opts) || this;\n    _this.type = 'uploader';\n    _this.id = _this.opts.id || 'AwsS3';\n    _this.title = 'AWS S3';\n    _this.defaultLocale = {\n      strings: {\n        timedOut: 'Upload stalled for %{seconds} seconds, aborting.'\n      }\n    };\n    var defaultOptions = {\n      timeout: 30 * 1000,\n      limit: 0,\n      metaFields: [],\n      // have to opt in\n      getUploadParameters: _this.getUploadParameters.bind(_assertThisInitialized(_this))\n    };\n    _this.opts = _extends({}, defaultOptions, opts);\n\n    _this.i18nInit();\n\n    _this.client = new RequestClient(uppy, opts);\n    _this.handleUpload = _this.handleUpload.bind(_assertThisInitialized(_this));\n    _this.requests = new RateLimitedQueue(_this.opts.limit);\n    return _this;\n  }\n\n  var _proto = AwsS3.prototype;\n\n  _proto.setOptions = function setOptions(newOpts) {\n    _Plugin.prototype.setOptions.call(this, newOpts);\n\n    this.i18nInit();\n  };\n\n  _proto.i18nInit = function i18nInit() {\n    this.translator = new Translator([this.defaultLocale, this.uppy.locale, this.opts.locale]);\n    this.i18n = this.translator.translate.bind(this.translator);\n    this.setPluginState(); // so that UI re-renders and we see the updated locale\n  };\n\n  _proto.getUploadParameters = function getUploadParameters(file) {\n    if (!this.opts.companionUrl) {\n      throw new Error('Expected a `companionUrl` option containing a Companion address.');\n    }\n\n    var filename = file.meta.name;\n    var type = file.meta.type;\n    var metadata = {};\n    this.opts.metaFields.forEach(function (key) {\n      if (file.meta[key] != null) {\n        metadata[key] = file.meta[key].toString();\n      }\n    });\n    var query = qsStringify({\n      filename: filename,\n      type: type,\n      metadata: metadata\n    });\n    return this.client.get(\"s3/params?\" + query).then(assertServerError);\n  };\n\n  _proto.validateParameters = function validateParameters(file, params) {\n    var valid = typeof params === 'object' && params && typeof params.url === 'string' && (typeof params.fields === 'object' || params.fields == null) && (params.method == null || /^(put|post)$/i.test(params.method));\n\n    if (!valid) {\n      var err = new TypeError(\"AwsS3: got incorrect result from 'getUploadParameters()' for file '\" + file.name + \"', expected an object '{ url, method, fields, headers }' but got '\" + JSON.stringify(params) + \"' instead.\\nSee https://uppy.io/docs/aws-s3/#getUploadParameters-file for more on the expected format.\");\n      console.error(err);\n      throw err;\n    }\n  };\n\n  _proto.handleUpload = function handleUpload(fileIDs) {\n    var _this2 = this;\n\n    /**\n     * keep track of `getUploadParameters()` responses\n     * so we can cancel the calls individually using just a file ID\n     *\n     * @type {object.<string, Promise>}\n     */\n    var paramsPromises = Object.create(null);\n\n    function onremove(file) {\n      var id = file.id;\n\n      if (hasProperty(paramsPromises, id)) {\n        paramsPromises[id].abort();\n      }\n    }\n\n    this.uppy.on('file-removed', onremove);\n    fileIDs.forEach(function (id) {\n      var file = _this2.uppy.getFile(id);\n\n      _this2.uppy.emit('upload-started', file);\n    });\n    var getUploadParameters = this.requests.wrapPromiseFunction(function (file) {\n      return _this2.opts.getUploadParameters(file);\n    });\n    var numberOfFiles = fileIDs.length;\n    return settle(fileIDs.map(function (id, index) {\n      paramsPromises[id] = getUploadParameters(_this2.uppy.getFile(id));\n      return paramsPromises[id].then(function (params) {\n        delete paramsPromises[id];\n\n        var file = _this2.uppy.getFile(id);\n\n        _this2.validateParameters(file, params);\n\n        var _params$method = params.method,\n            method = _params$method === void 0 ? 'post' : _params$method,\n            url = params.url,\n            fields = params.fields,\n            headers = params.headers;\n        var xhrOpts = {\n          method: method,\n          formData: method.toLowerCase() === 'post',\n          endpoint: url,\n          metaFields: fields ? Object.keys(fields) : []\n        };\n\n        if (headers) {\n          xhrOpts.headers = headers;\n        }\n\n        _this2.uppy.setFileState(file.id, {\n          meta: _extends({}, file.meta, fields),\n          xhrUpload: xhrOpts\n        });\n\n        return _this2._uploader.uploadFile(file.id, index, numberOfFiles);\n      }).catch(function (error) {\n        delete paramsPromises[id];\n\n        var file = _this2.uppy.getFile(id);\n\n        _this2.uppy.emit('upload-error', file, error);\n      });\n    })).then(function (settled) {\n      // cleanup.\n      _this2.uppy.off('file-removed', onremove);\n\n      return settled;\n    });\n  };\n\n  _proto.install = function install() {\n    var uppy = this.uppy;\n    this.uppy.addUploader(this.handleUpload); // Get the response data from a successful XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n\n    function defaultGetResponseData(content, xhr) {\n      var opts = this; // If no response, we've hopefully done a PUT request to the file\n      // in the bucket on its full URL.\n\n      if (!isXml(content, xhr)) {\n        if (opts.method.toUpperCase() === 'POST') {\n          if (!warnedSuccessActionStatus) {\n            uppy.log('[AwsS3] No response data found, make sure to set the success_action_status AWS SDK option to 201. See https://uppy.io/docs/aws-s3/#POST-Uploads', 'warning');\n            warnedSuccessActionStatus = true;\n          } // The responseURL won't contain the object key. Give up.\n\n\n          return {\n            location: null\n          };\n        } // responseURL is not available in older browsers.\n\n\n        if (!xhr.responseURL) {\n          return {\n            location: null\n          };\n        } // Trim the query string because it's going to be a bunch of presign\n        // parameters for a PUT requestâ€”doing a GET request with those will\n        // always result in an error\n\n\n        return {\n          location: xhr.responseURL.replace(/\\?.*$/, '')\n        };\n      }\n\n      return {\n        // Some S3 alternatives do not reply with an absolute URL.\n        // Eg DigitalOcean Spaces uses /$bucketName/xyz\n        location: resolveUrl(xhr.responseURL, getXmlValue(content, 'Location')),\n        bucket: getXmlValue(content, 'Bucket'),\n        key: getXmlValue(content, 'Key'),\n        etag: getXmlValue(content, 'ETag')\n      };\n    } // Get the error data from a failed XMLHttpRequest instance.\n    // `content` is the S3 response as a string.\n    // `xhr` is the XMLHttpRequest instance.\n\n\n    function defaultGetResponseError(content, xhr) {\n      // If no response, we don't have a specific error message, use the default.\n      if (!isXml(content, xhr)) {\n        return;\n      }\n\n      var error = getXmlValue(content, 'Message');\n      return new Error(error);\n    }\n\n    var xhrOptions = {\n      fieldName: 'file',\n      responseUrlFieldName: 'location',\n      timeout: this.opts.timeout,\n      // Share the rate limiting queue with XHRUpload.\n      __queue: this.requests,\n      responseType: 'text',\n      getResponseData: this.opts.getResponseData || defaultGetResponseData,\n      getResponseError: defaultGetResponseError\n    }; // Only for MiniXHRUpload, remove once we can depend on XHRUpload directly again\n\n    xhrOptions.i18n = this.i18n; // Revert to `this.uppy.use(XHRUpload)` once the big comment block at the top of\n    // this file is solved\n\n    this._uploader = new MiniXHRUpload(this.uppy, xhrOptions);\n  };\n\n  _proto.uninstall = function uninstall() {\n    this.uppy.removePreProcessor(this.handleUpload);\n  };\n\n  return AwsS3;\n}(Plugin), _class.VERSION = \"1.7.0\", _temp);"]},"metadata":{},"sourceType":"script"}