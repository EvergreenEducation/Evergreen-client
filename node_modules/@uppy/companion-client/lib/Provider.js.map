{"version":3,"sources":["Provider.js"],"names":["RequestClient","require","tokenStorage","_getName","id","split","map","s","charAt","toUpperCase","slice","join","module","exports","uppy","opts","provider","name","pluginId","tokenKey","headers","Promise","all","getAuthToken","then","token","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","getItem","authUrl","hostname","fileUrl","list","directory","get","logout","removeItem","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","Error","companionAllowedHosts","pattern","Array","isArray","RegExp","TypeError","test","companionUrl","replace"],"mappings":"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","sourcesContent":["'use strict'\n\nconst RequestClient = require('./RequestClient')\nconst tokenStorage = require('./tokenStorage')\n\nconst _getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nmodule.exports = class Provider extends RequestClient {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || _getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n  }\n\n  headers () {\n    return Promise.all([super.headers(), this.getAuthToken()])\n      .then(([headers, token]) =>\n        Object.assign({}, headers, { 'uppy-auth-token': token })\n      )\n  }\n\n  onReceiveResponse (response) {\n    response = super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  // @todo(i.olarewaju) consider whether or not this method should be exposed\n  setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  authUrl () {\n    return `${this.hostname}/${this.id}/connect`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  list (directory) {\n    return this.get(`${this.id}/list/${directory || ''}`)\n  }\n\n  logout () {\n    return this.get(`${this.id}/logout`)\n      .then((response) => Promise.all([\n        response,\n        this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)\n      ])).then(([response]) => response)\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = Object.assign({}, defaultOpts, opts)\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else {\n      // does not start with https://\n      if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n        plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n      } else {\n        plugin.opts.companionAllowedHosts = opts.companionUrl\n      }\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n  }\n}\n"]}